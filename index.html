<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Amortization + Prepayment Calculator</title>
  <style>
    :root{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
    body{margin:0;background:#f6f7fb;color:#0f172a;padding:24px;}
    .card{background:#fff;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,42,0.06);padding:20px;max-width:980px;margin:0 auto}
    h1{margin:0 0 12px;font-size:20px}
    label{display:block;font-size:13px;margin-top:12px}
    input,select{width:100%;padding:8px 10px;margin-top:6px;border:1px solid #e6e9ef;border-radius:8px;font-size:14px}
    .row{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    .row-2{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    button{margin-top:14px;padding:10px 14px;border-radius:10px;border:0;background:#0b63ff;color:white;cursor:pointer}
    .small{font-size:13px;color:#475569}
    table{width:100%;border-collapse:collapse;margin-top:18px}
    th,td{padding:8px;border-bottom:1px solid #eef2ff;text-align:right;font-size:13px}
    th{background:#fbfdff;text-align:right}
    .mono{font-family:monospace}
    .flex{display:flex;gap:12px;align-items:center}
    .muted{color:#6b7280;font-size:13px}
    .summary{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
    .pill{background:#f1f5f9;padding:10px;border-radius:10px;min-width:160px}
    .danger{background:#fff7f7;border:1px solid #ffdede}
    .controls{margin-top:12px}
    .actions{display:flex;gap:8px}
    @media (max-width:900px){.row{grid-template-columns:1fr}.row-2{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="card">
    <h1>Amortization & Prepayment Simulator</h1>
    <div class="small muted">Enter loan details below. You can simulate X extra principal prepayments per year (default = extra EMI amount) and compare results vs no prepayment.</div>

    <div class="row" style="margin-top:16px">
      <div>
        <label>Loan amount (₹)</label>
        <input id="principal" type="number" value="3200000" min="1">
      </div>
      <div>
        <label>Tenure (years)</label>
        <input id="years" type="number" value="20" min="1">
      </div>
      <div>
        <label>Monthly EMI (optional — leave empty to compute from rate)</label>
        <input id="emiInput" type="number" placeholder="e.g. 30000">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Annual interest rate (% pa) — if unknown, check 'Compute rate from EMI'</label>
        <input id="annualRate" type="number" step="0.01" value="9.3">
      </div>
      <div>
        <label><input id="solveRate" type="checkbox"> Compute annual rate from EMI</label>
        <div class="small muted">When checked, the calculator will find an interest rate that yields the EMI you entered.</div>
      </div>
      <div>
        <label>Extra prepayments / year (count)</label>
        <input id="prepayCount" type="number" value="2" min="0">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <div>
        <label>Each prepayment amount (₹) — default = EMI</label>
        <input id="prepayAmount" type="number" placeholder="If empty, EMI value used">
      </div>
      <div>
        <label>Apply prepayments starting after (months)</label>
        <input id="startAfter" type="number" value="12" min="1">
      </div>
      <div>
        <label>Max months to simulate (safety cap)</label>
        <input id="maxMonths" type="number" value="600" min="1">
      </div>
    </div>

    <div class="controls">
      <div class="actions">
        <button id="run">Run simulation</button>
        <button id="csv">Download CSV</button>
        <button id="reset">Reset inputs</button>
      </div>
    </div>

    <div id="results" style="margin-top:18px"></div>

    <div id="tableWrap"></div>
  </div>

  <script>
    function fmt(v){return typeof v==='number'?v.toLocaleString('en-IN',{maximumFractionDigits:2}):v}

    function computeEMI(P, monthlyRate, n){
      if(monthlyRate===0) return P / n;
      const r = monthlyRate;
      return (P * r * Math.pow(1+r,n)) / (Math.pow(1+r,n)-1);
    }

    function findAnnualRateFromEMI(P, n, targetEMI){
      // bisection on annual rate between 0% and 30%
      let lo = 0, hi = 0.3, mid;
      for(let i=0;i<60;i++){
        mid = (lo+hi)/2;
        const emi = computeEMI(P, mid/12, n);
        if(emi>targetEMI) hi = mid; else lo = mid;
      }
      return mid*100; // percent
    }

    function simulate(principal, annualRatePercent, months, EMI, prepayCount, prepayAmount, startAfter, maxMonths){
      const r = annualRatePercent/100/12;
      let balance = principal;
      const schedule = [];
      let month = 0;
      let totalInterest = 0;
      prepayAmount = prepayAmount || EMI;
      // prepayment months offset calculation
      const spacing = prepayCount>0 ? Math.round(12 / prepayCount) : 0;

      while(balance>0.0001 && month < maxMonths){
        month++;
        const interest = balance * r;
        let principalPaid = EMI - interest;
        // if EMI is insufficient (interest > EMI) - negative amortization
        if(principalPaid < 0){
          // apply EMI to interest only, principal will increase
          balance += (interest - EMI);
          totalInterest += EMI; // treat EMI as interest paid for accounting
          schedule.push({month, EMI, interestPaid: EMI, principalPaid: 0, balance});
          continue;
        }

        if(principalPaid > balance){
          principalPaid = balance;
        }

        balance -= principalPaid;
        totalInterest += interest;

        // apply prepayment if this month qualifies
        const monthsSinceStart = month; // months from beginning
        let prepaymentThisMonth = 0;
        if(prepayCount>0 && monthsSinceStart >= startAfter){
          // determine if month is a prepayment month: check month of year
          const monthOfYear = ((month-1) % 12) + 1; // 1..12
          // pick months: spacing, spacing*2,... and also include month 12
          // we'll mark prepayment when monthOfYear % spacing==0 OR monthOfYear==12 (covers spacing that isn't divisor)
          if(spacing>0){
            // compute planned months: k*spacing where k from 1..prepayCount
            for(let k=1;k<=prepayCount;k++){
              const planned = Math.round(k*12/prepayCount);
              if(monthOfYear === planned){
                prepaymentThisMonth = Math.min(prepayAmount, balance);
                balance -= prepaymentThisMonth;
                break;
              }
            }
          }
        }

        schedule.push({month, EMI, interestPaid: interest, principalPaid, prepayment: prepaymentThisMonth, balance});
      }

      const monthsPaid = schedule.length;
      const totalPaid = (monthsPaid * EMI) + schedule.reduce((s,st)=>s+ (st.prepayment||0),0);
      return {schedule, monthsPaid, totalInterest, totalPaid};
    }

    document.getElementById('run').addEventListener('click', ()=>{
      const P = parseFloat(document.getElementById('principal').value) || 0;
      const years = parseFloat(document.getElementById('years').value) || 0;
      const n = Math.round(years*12);
      const emiInput = parseFloat(document.getElementById('emiInput').value) || null;
      const solveRate = document.getElementById('solveRate').checked;
      let annualRate = parseFloat(document.getElementById('annualRate').value) || 0;
      const prepayCount = parseInt(document.getElementById('prepayCount').value) || 0;
      const prepayAmount = parseFloat(document.getElementById('prepayAmount').value) || null;
      const startAfter = parseInt(document.getElementById('startAfter').value) || 12;
      const maxMonths = parseInt(document.getElementById('maxMonths').value) || 600;

      if(P<=0 || years<=0){ alert('Enter valid principal and tenure'); return; }

      let EMI = emiInput;
      if(solveRate && emiInput){
        // find rate that gives EMI for original tenure
        annualRate = findAnnualRateFromEMI(P, n, EMI);
        document.getElementById('annualRate').value = annualRate.toFixed(4);
      }

      if(!EMI){
        // compute EMI from given rate
        EMI = computeEMI(P, (annualRate/100)/12, n);
      }

      // baseline (no prepayment) amortization until n months
      const baseline = simulate(P, annualRate, n, EMI, 0, 0, maxMonths, maxMonths);
      // scenario with prepayments each year
      const scenario = simulate(P, annualRate, n, EMI, prepayCount, prepayAmount, startAfter, maxMonths);

      // summaries
      const resultsEl = document.getElementById('results');
      resultsEl.innerHTML = `
        <div class="summary">
          <div class="pill">
            <div class="muted">EMI</div>
            <div class="mono">₹ ${fmt(EMI)}</div>
          </div>
          <div class="pill">
            <div class="muted">Baseline tenure</div>
            <div class="mono">${Math.floor(baseline.monthsPaid/12)} yr ${baseline.monthsPaid%12} mo</div>
          </div>
          <div class="pill">
            <div class="muted">Scenario tenure</div>
            <div class="mono">${Math.floor(scenario.monthsPaid/12)} yr ${scenario.monthsPaid%12} mo</div>
          </div>
          <div class="pill">
            <div class="muted">Baseline total interest</div>
            <div class="mono">₹ ${fmt(baseline.totalInterest)}</div>
          </div>
          <div class="pill">
            <div class="muted">Scenario total interest</div>
            <div class="mono">₹ ${fmt(scenario.totalInterest)}</div>
          </div>
          <div class="pill">
            <div class="muted">Interest saved</div>
            <div class="mono">₹ ${fmt(Math.max(0, baseline.totalInterest - scenario.totalInterest))}</div>
          </div>
          <div class="pill">
            <div class="muted">Months saved</div>
            <div class="mono">${Math.max(0, baseline.monthsPaid - scenario.monthsPaid)} months</div>
          </div>
        </div>
      `;

      // build table showing first 60 rows and last few rows
      const wrap = document.getElementById('tableWrap');
      const rowsToShow = 60;
      let html = '<h3 style="margin-top:18px">Amortization schedule (first rows) — scenario</h3>';
      html += '<table><thead><tr><th>Month</th><th>EMI</th><th>Interest</th><th>Principal</th><th>Prepayment</th><th>Balance</th></tr></thead><tbody>';
      for(let i=0;i<Math.min(scenario.schedule.length, rowsToShow);i++){
        const s = scenario.schedule[i];
        html += `<tr><td style="text-align:left">${s.month}</td><td>₹ ${fmt(s.EMI)}</td><td>₹ ${fmt(s.interestPaid)}</td><td>₹ ${fmt(s.principalPaid)}</td><td>₹ ${fmt(s.prepayment||0)}</td><td>₹ ${fmt(s.balance)}</td></tr>`;
      }
      html += '</tbody></table>';
      if(scenario.schedule.length > rowsToShow){
        const last = scenario.schedule.slice(-6);
        html += '<h4 style="margin-top:14px">Last rows</h4>';
        html += '<table><thead><tr><th>Month</th><th>EMI</th><th>Interest</th><th>Principal</th><th>Prepayment</th><th>Balance</th></tr></thead><tbody>';
        for(const s of last){
          html += `<tr><td style="text-align:left">${s.month}</td><td>₹ ${fmt(s.EMI)}</td><td>₹ ${fmt(s.interestPaid)}</td><td>₹ ${fmt(s.principalPaid)}</td><td>₹ ${fmt(s.prepayment||0)}</td><td>₹ ${fmt(s.balance)}</td></tr>`;
        }
        html += '</tbody></table>';
      }

      wrap.innerHTML = html;

      // store latest CSV content for download
      window._latestCSV = buildCSV(scenario.schedule);
    });

    function buildCSV(schedule){
      const rows = [['Month','EMI','Interest','Principal','Prepayment','Balance']];
      for(const s of schedule){
        rows.push([s.month, s.EMI.toFixed(2), s.interestPaid.toFixed(2), s.principalPaid.toFixed(2), (s.prepayment||0).toFixed(2), s.balance.toFixed(2)]);
      }
      return rows.map(r => r.join(',')).join('\n');
    }

    document.getElementById('csv').addEventListener('click', ()=>{
      const data = window._latestCSV;
      if(!data){ alert('Run a simulation first'); return; }
      const blob = new Blob([data], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'amortization_schedule.csv';
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(url);
    });

    document.getElementById('reset').addEventListener('click', ()=>{
      document.getElementById('principal').value = 3200000;
      document.getElementById('years').value = 20;
      document.getElementById('emiInput').value = 30000;
      document.getElementById('annualRate').value = 9.3;
      document.getElementById('solveRate').checked = false;
      document.getElementById('prepayCount').value = 2;
      document.getElementById('prepayAmount').value = '';
      document.getElementById('startAfter').value = 12;
      document.getElementById('maxMonths').value = 600;
      document.getElementById('results').innerHTML = '';
      document.getElementById('tableWrap').innerHTML = '';
    });

    // initialize
  </script>
</body>
</html>